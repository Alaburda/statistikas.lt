---
title: "Išmokti statistiką per 3 valandas"
subtitle: "Vidurkių lyginimas tarp 2 ir daugiau grupių"
author: "Paulius Alaburda"
format: 
  revealjs:
    width: 1600
---

## 

## Ko išmoksime?

-   Pasirinkti tinkamą statistinį testą
-   Atlikti koreliaciją
-   Palyginti 2 grupes tarpusavyje
-   Palyginti 3+ grupes tarpusavyje
-   Atlikti post-hoc testus

## K

-   Programuoti su R
-   Tiesinė regresija
-   Logistinė regresija

## Apie jus darau prielaidas

-   Grubiai žinote, kas yra vidurkis, standartinis nuokrypis, variacija

-   Esate bent kartą atlikę statistinį testą (su Excel, SPSS, GraphPad ir pan.)

## Kokių priemonių reikės?

Sekti mokymus galima šiais būdais:

-   Susikurti paskyrą [Posit Cloud](https://posit.cloud/) svetainėje - nereikia siųstis programinės įrangos!

-   Parsisiųsti [RStudio](https://posit.co/download/rstudio-desktop/), jeigu norite naudotis R bei sekti [šį diegimo gidą](../kaip-pasirengti-rstudio/kaip-pasirengti-rstudio.qmd);

-   Parsiųsti [XLMiner Analysis ToolPak](https://appsource.microsoft.com/en-us/product/office/wa104379190?tab=overview&exp=ubp8), jeigu norite naudotis Excel;

## Kaip pasirengti Posit Cloud paskyrą?

-   Užsiregistruoti [čia](https://login.posit.cloud/register).

-   Posit pradiniame lange pasirinkti Posit Cloud:

![](images/image-1832016710.png)

## Susikurti naują RStudio aplinką

![](images/image-1067007752.png)

Posit jums sukurs virtualią RStudio aplinką. Ši aplinka yra praktiškai tokia pati kaip parsisiuntus RStudio. Apie RStudio detalesnis aprašas [čia](../kaip-pasirengti-rstudio/kaip-pasirengti-rstudio.qmd).

# Kas yra tiesiniai modeliai?

## Tiesiniai modeliai ranka

::: columns
::: {.column width="50%"}
![](images/image-1204024637.png)
:::

::: {.column width="50%"}
![](images/image-1285293873.png)
:::
:::

## Parametriniai statistiniai testai

Dauguma parametrinių statistinių testų yra specifinės tiesinių modelių versijos. Tiesiniai modeliai turi formą $y = a*x + b$, kur **y** yra mūsų priklausomas kintamasis, o **x** - nepriklausomas kintamasis.

. . .

::: columns
::: {.column width="40%"}
Pavyzdžiui:

```{r, echo = FALSE}

library(dplyr)
library(knitr)

data.frame(Baterija = c("10%","20%","30%","70%","100%"), 
           `Minutės` = c(0,10,20,60,90)) %>% 
  knitr::kable()

```
:::

::: {.column width="60%"}
Remiantis lentele, tiesinis modelis galėtų atrodyti taip:

y = 1\*x + 10
:::
:::

## Bet realybė nėra tokia tvarkinga...

Pavyzdžiui, grafike matome `penguins` duomenų rinkinio kūno masės ir pelekų ilgį. Akivaizdu, jog priklausomybė yra tiesiška ir proporcinga -- kokia pora **a** ir **b** kintamųjų geriausiai apibūdintų ryšį?

```{r, echo = FALSE}

library(ggplot2)
library(palmerpenguins)

penguin_plot <- ggplot(penguins, aes(x = body_mass_g, y = flipper_length_mm)) + geom_point()

penguin_plot
```

## Kuri tiesė teisinga? Ar tai turėtų būti tiesė apskritai?

"Iš akies" galėtume nubrėžti kalibracinę tiesę, bet ar tai optimaliausia tiesė, kuri geriausiai apibūdintų **visus** mūsų atliktus matavimus? Juo labiau, ar tiesė geriausiai apibūdina mūsų santykį, ar kreivė?

<div>

```{r, echo = FALSE}
#| fig-pos: 'c'

penguin_plot + geom_abline(slope = 0.01528, intercept = 136.73, color = "navyblue", size = 1.5) + geom_abline(slope = 0.019, intercept = 120, color = "salmon", size = 1.5) + geom_smooth(method = "loess", se = FALSE, color = "magenta")
```

</div>

## OLS -- ordinary least squares (liet. mažiausių kvadratų modelis)

::: columns
::: {.column width="40%"}
OLS yra tiesinis metodas, kuris nustato nežinomus parametrus tiesinės regresijos modelyje. Metodo tikslas yra sumažinti skirtumų tarp matavimų ir tiesės kvadratų sumą.

**Kitaip tariant, metodas nustato, kuri tiesė turi mažiausią paklaidą santykiu su mūsų matavimais.**
:::

::: {.column width="60%"}
![](images/pca.gif){width="460"}
:::
:::

## OLS yra labai patogus modelis

-   **Lengva apibendrinti** - nepaisant nepriklausomo kintamojo, ryšys tarp jo ir priklausomo kintamojo visada išlieka toks pats. Galime drąsiai teigti, jog "kiekvienas papildomas pingvino gramas yra susijęs su 0.01528 mm ilgesniu peleku".

. . .

-   **Lengva interpretuoti** - duomenys liko tuose pačiuose matavimo vienetuose. Logistinės regresijos modeliai bei bendriniai tiesiniai modeliai turi būti interpretuojami per šansų santykius, procentinius pokyčius ir pan.

. . .

-   **Greitas** - sudėtingi Bajeso modeliai yra tinkamesni, bet gali trukti minutes (o dideli ir valandas!), kol bus apskaičiuoti.

## OLS turi savo kainą

::: columns
::: {.column width="40%"}
-   Tiesiniai modeliai taip pat apskaičiuoja paklaidą - ji turi būti vienoda visoje matavimo aibėje (heteroskedatiškumas)
-   Tiesiniai modelių paklaida taip pat turi būti pasiskirsčiusi pagal normalųjį skirstinį
-   Matavimai turi būti nepriklausomi vienas nuo kito
:::

::: {.column width="60%"}
```{r, echo = FALSE}

penguin_plot + geom_smooth(method = "lm", color = "magenta") + labs(title = "Ar tiesinis modelis yra tinkamas apibūdinti santykį tarp svorio pelekų ilgio?")
```
:::
:::

## Kada netaikyti tiesinių modelių?

::: columns
::: {.column width="30%"}
-   Ar tiesė yra pakankamai geras būdas apibūdinti ryšį tarp mano kintamųjų?

-   Jeigu iš duomenų negalima to pasakyti, ar iš principo tiesė būtų geras būdas apibūdinti ryšį?
:::

::: {.column width="70%"}
```{r, echo = FALSE}

library(dplyr)
library(tidyr)

anscombe_tidy <- anscombe %>%
    mutate(observation = seq_len(n())) %>%
    pivot_longer(names_to = "key", values_to = "value", -observation) %>%
    separate(key, c("variable", "set"), 1, convert = TRUE) %>%
    mutate(set = c("I", "II", "III", "IV")[set]) %>% 
    pivot_wider(names_from = "variable", values_from = "value")

ggplot(anscombe_tidy, aes(x, y)) +
    geom_point() +
    facet_wrap(~ set) +
    geom_smooth(method = "lm", se = FALSE) + 
    labs(title = "Anscombe’s kvartetas", subtitle = "Visi 4 grafikai turi vienodus vidurkius, variaciją bei tiesinės regresijos tieses")

```
:::
:::

# Alternatyva tiesiniams modeliams

## Neparametriniai testai yra tiesiog ranginiai modeliai

::: columns
::: {.column width="70%"}
Grubiai, kiekvienas atitinkamas neparametrinis testas pirma ranguoja duomenis, o tada atlieka statistinį testą.

```{r, echo = FALSE}

library(dplyr)
library(knitr)

data.frame(Baterija = c("10%","20%","30%","70%","100%"), 
           `Minutės` = c(0,10,20,60,90),
           Rangas = 1:5) %>% 
  knitr::kable()

```
:::

::: {.column width="30%"}
Pavyzdžiui, Spearman koreliacijos koeficientas yra identiškas tiesinės regresijos *a* koeficientui, jeigu suvienodiname priklausomo ir nepriklausomo kintamojo standartinius nuokrypius.

```{r, echo = FALSE, warning = FALSE}

a = cor.test(penguins$flipper_length_mm, penguins$body_mass_g, method = "spearman")

b = lm(rank(flipper_length_mm) ~ rank(body_mass_g), data = penguins)

a$estimate
b$coefficients

```
:::
:::

# Susipažinimas su RStudio Cloud

Darbui su RStudio Cloud mums reikės šių paketų:

```{r, eval = FALSE, echo = TRUE}

install.packages(c("reaxl","ggplot2","dplyr","tidyr","patchwork","car"))

```

# Pagrindiniai statistiniai testai

## Pearson koreliacijos koeficientas

::: columns
::: {.column width="50%"}
```{r, echo = TRUE}

cor.test(penguins$flipper_length_mm, penguins$body_mass_g, method = "pearson")
```
:::

::: {.column width="50%"}
![Iliustracija iš Danielle Navarro knygos "Learning Statistics with R". Kuo koreliacija yra arčiau nulio, tau labiau mūsų duomenys panašūs į debesėlį. 1 ir -1 yra, atitinkamai, tobula teigiama bei neigiama koreliacija.](../posts/kaip-apskaiciuoti-koreliacija/images/image-1260747057.png){width="374"}
:::
:::

## Spearman koreliacijos koeficientas

```{r, echo = TRUE}

cor.test(penguins$flipper_length_mm, penguins$body_mass_g, method = "spearman")

```

Atlikus Spearman ranginį koreliacijos testą, koreliacija tarp pelekų ilgio ir kūno masės buvo stipri (r = 0,840, p \< 0,001).

## Stjudento t-testas

::: panel-tabset
## Testas

```{r, echo = TRUE}

t.test(data = penguins, flipper_length_mm ~ sex)
```

"Atlikus Stjudento t-testą, vidutinis pelekų ilgio skirtumas tarp pingvinių lyčių buvo 7,14 mm, skirtumas buvo statistiškai reikšmingas (t = 4,80, 95% PI 4,21-10,06, p \< 0,001)."

## Grafikas

```{r, echo = TRUE}

ggplot(data = penguins, aes(x = sex, y = flipper_length_mm)) + geom_boxplot()
```

## Pasitikrinimas

```{r, echo = TRUE}

ggplot(data = penguins, aes(x = flipper_length_mm)) + geom_histogram() + facet_grid(~sex)
```
:::

## Stjudento t-testas 2

::: columns
::: {.column width="50%"}
```{r, echo = TRUE}

t.test(data = penguins, flipper_length_mm ~ sex)
```

"Atlikus Stjudento t-testą, vidutinis pelekų ilgio skirtumas tarp pingvinių lyčių buvo 7,14 mm, skirtumas buvo statistiškai reikšmingas (t = 4,80, 95% PI 4,21-10,06, p \< 0,001)."
:::

::: {.column width="50%"}
```{r, echo = TRUE}

ggplot(data = penguins, aes(x = sex, y = flipper_length_mm)) + geom_boxplot()
```
:::
:::

## Mann-Whitney U

```{r, echo = TRUE}

wilcox.test(data = penguins, flipper_length_mm ~ sex)

```

Atlikus Mann-Whitney U testą, pelekų ilgio skirtumas tarp lyčių buvo statistiškai reikšmingas (W = 9547, p \< 0,001).

## Poruotas Stjudento t-testas

## Wilcoxon ranginis testas

## VIenpusė ANOVA

::: columns

::: {.column width="40%"}
### Kaip atlikti

```{r}

my.anova <- aov(data = penguins, body_mass_g ~ species)

summary(my.anova)

```

Adelie rūšies pingvinai vidutiniškai svėrė 3,70 kg (SD = 0,46), Chinstrap svėrė 3,73 kg (SD = 0,38), Gentoo svėrė 5,08 kg (SD = 0,5). Skirtumas tarp rūšių vidurkių buvo statistiškai reikšmingas (F(2,339) = 343,6, p \< 0,001).
:::

::: {.column width="60%"}
### Kaip vizualizuoti

```{r}
ggplot(penguins, aes(x = species, y = body_mass_g)) + geom_boxplot() + labs(x = "Rūšis", y = "Kūno masė, g")
```
:::
:::

## ANOVA diagnostika - heteroskedatiškumas

ANOVA homoskedatiškumo prielaidą tikriname taip:

```{r}

library(car)

leveneTest(my.anova)

```

Levene testas rodo, jog mes sulaužėme homogeniškos variacijos (homoskedatiškumo) prielaidą ir tokiu būdu mūsų paklaidos nebėra [tikslios](https://stats.stackexchange.com/questions/22800/what-are-the-dangers-of-violating-the-homoscedasticity-assumption-for-linear-reg).

## ANOVA diagnostika - residuals su Shapiro-Wilk testu

```{r}

shapiro.test(residuals(my.anova))
```

## ANOVA diagnostika - residuals grafiškai

```{r}

library(patchwork)

p1 <- ggplot() + aes(sample = residuals(my.anova)) + stat_qq() + stat_qq_line(color = "red")

p2 <- ggplot() + aes(x = residuals(my.anova)) + geom_histogram()

p1 + p2

```

QQ grafikas didžiąja dalimi atitinka tiesę, bet nukrypsta ties labai mažomis ir labai didelėmis reikšmėmis. Histograma taip pat rodo, jog "uodegos" turi daugiau reikšmių negu idealiai norėtume.

## Post-hoc testai - Tukey HSD

Tukey HSD (Honestly Significant Difference) yra standartinis būdas patikrinti porinius skirtumus tarp grupių.

```{r}

TukeyHSD(my.anova)


```

## Kruskal-Wallis testas

::: columns

::: {.column width="40%"}
### Kaip atlikti

```{r}

kruskal.test(data = penguins, body_mass_g ~ species)

```

Adelie rūšies pingvinai vidutiniškai svėrė 3,70 kg (SD = 0,46), Chinstrap svėrė 3,73 kg (SD = 0,38), Gentoo svėrė 5,08 kg (SD = 0,5). Skirtumas tarp rūšių buvo statistiškai reikšmingas (χ^2^(2) = 217,6, p \< 0,001).
:::

::: {.column width="60%"}
### Kaip vizualizuoti

```{r}
ggplot(penguins, aes(x = species, y = body_mass_g)) + geom_boxplot() + geom_jitter(alpha = 0.3) + labs(x = "Rūšis", y = "Kūno masė, g")
```
:::
:::

## Dvipusė ANOVA

::: columns

::: {.column width="40%"}
### Kaip atlikti

```{r, echo = TRUE}

my.anova.2 <- aov(data = penguins, body_mass_g ~ species + sex + species:sex)

summary(my.anova.2)

```
:::

::: {.column width="60%"}
### Kaip vizualizuoti

```{r}
ggplot(penguins, aes(x = species, y = body_mass_g, fill = sex)) + geom_boxplot() + labs(x = "Rūšis", y = "Kūno masė, g", fill = "Lytis")
```
:::
:::

## Dvipusės ANOVA interpretacija

::: columns

::: {.column width="60%"}
### Kintamųjų įtaka

```{r, echo = TRUE}

library(lsr)

etaSquared(my.anova.2)

```

ANOVA modelis paaiškina 84,63% pingvinų svorio variacijos. Pingvinų rūšis buvo pagrindinis veiksnys lemiantis pingvinų svorį ir paaiškino 66,62% variacijos. Lytis turėjo mažesnę įtaką variacijai ir paaiškino tik 17,23% variacijos. Sąveika tarp rūšies ir lyties turėjo itin mažą įtaką (0,77%).
:::

::: {.column width="40%"}
### Vidutinis svoris grupėje

```{r, echo = TRUE}

library(effects)

eff <- effect( term = "species*sex", mod = my.anova.2 )
summary(eff)
```
:::
:::

# Apibendrinimas

## Ką reikia žinoti?

-   Naudokitės grafikais prieš atlikdami bet kokį statistinį testą

-   Statistinio testo pasirinkimą lemia ne tik surinkti duomenys, bet ir tyrimo dizainas bei mūsų žinios apie tyrimo temą
